<div class="related-posts">
  <h2>Related Posts</h2>

  <ul>
    {% for post in site.posts %}

      {% assign sameTagCount = 0 %}
      {% assign commonTags = '' %}

      {% for tag in post.tags %}
        {% if page.tags contains tag %}

          {% assign sameTagCount = sameTagCount | plus: 1 %}
          {% capture tagmarkup %} <span class="label">{{ tag }}</span> {% endcapture %}
          {% assign commonTags = commonTags | append: tagmarkup %}

        {% endif %}
      {% endfor %}

      {% if sameTagCount >= 2 and post != page %}
        <li><a href="{{ post.url }}">{{ post.title }}{{ commonTags }}</a></li>
      {% endif %}

    {% endfor %}
  </ul>
</div>
